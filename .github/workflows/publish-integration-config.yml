name: Publish GitLab Integration Config

concurrency:
  group: gitlab-enterprise-connector-${{ github.ref }}
  cancel-in-progress: true

on:
  workflow_dispatch:

env:
  ACTION_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

jobs:
  publish:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.build-and-deploy.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Inject secret store credentials
        uses: leanix/secrets-action@master
        with:
          secret-store-credentials: ${{ secrets.INJECTED_SECRET_STORE_CREDENTIALS }}

      - name: Set deployment targets
        if: github.ref=='refs/heads/main'
        uses: leanix/infrastructure-regions@main
        id: set-targets
        with:
          github-token: ${{ env.GITHUB_TOKEN }}

      - name: Publish integration configuration
        id: vsm_integration_config
        uses: leanix/vsm-discovery-publish-action@main

      - name: Publish integration configuration to all prod regions
        id: vsm_integration_config_prod
        uses: leanix/vsm-discovery-publish-action@main
        if: github.ref=='refs/heads/main'
        with:
          integration-json: integration-configuration/integration-configuration.json
          assets-folder: integration-configuration/images

      - name: Publish integration configuration to test
        id: vsm_integration_config_test
        continue-on-error: true
        uses: leanix/vsm-discovery-publish-action@main
        if: github.ref!='refs/heads/main'
        with:
          integration-json: integration-configuration/integration-configuration.json
          assets-folder: integration-configuration/images
          deploy-test: 'true'